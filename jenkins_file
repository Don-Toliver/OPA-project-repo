pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/Don-Toliver/OPA-project-repo'
            }
        }
        stage('Install dependencies') {
            steps {
                sh 'terraform init'
            }
        }
        stage('Check Existing S3 Bucket') {
            steps {
                script {
                    def bucketExists = sh(script: 'aws s3api head-bucket --bucket automation-cicd-pro-ap-south-1', returnStatus: true) == 0
                    if (bucketExists) {
                        echo "Bucket already exists. Importing into Terraform."
                        sh 'terraform import aws_s3_bucket.example automation-cicd-pro-ap-south-1'
                    } else {
                        echo "Bucket does not exist. Proceeding to create."
                    }
                }
            }
        }
        stage('Terraform Plan') {
            steps {
                script {
                    def planFile = 'tfplan'
                    sh "terraform plan -out=${planFile}"
                }
            }
        }
        stage('Policy Check') {
            steps {
                script {
                    def policyCheck = sh(script: 'opa eval --data policy.rego --input tfplan.json "data.example.allow"', returnStatus: true)
                    if (policyCheck != 0) {
                        error("OPA policy violation detected. Failing the build.")
                    }
                }
            }
        }
        stage('Terraform Apply') {
            steps {
                sh "terraform apply -auto-approve tfplan"
            }
        }
    }
}


